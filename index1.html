<!--
 * @Author: ymq
 * @Date: 2022-01-05 18:50:51
 * @LastEditTime: 2022-01-25 18:24:43
 * @LastEditors: ymq
 * @Description: 
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style/index.css">
    <link rel="stylesheet" href="/static/style/base.css">
    <title>welcome to YDB chatroom</title>
</head>
<body>
    <div class="chat_wrap">
        <div class="news">
            <div class="news_title">欢迎来到衣大宝的聊天室</div>
            <div class="news_wrap" id="news_wrap">
                
            </div>
        </div>
        <div class="input_wrap">
            <div class="operate_area"></div>
            <div class="text_area">
                <textarea name="" id="message_send" cols="30" rows="10" placeholder="请输入"></textarea>
            </div>
            <div class="btn_area">
                <div class="button" onclick="sendMsg()">发送</div>
            </div>
        </div>
    </div>




    <script>
        let ws
        let nick_name

        

        function startLink(params) {
            nick_name = document.getElementById('nick_name').value
            if(!nick_name) return
            
            const modal = document.getElementById('modal')
            modal.style.display = 'none'
            ws = new WebSocket('ws://39.96.19.130:443/chat')
            ws.onopen = e => {
                // sessionStorage.setItem('nick_name', nick_name)
                ws.send(JSON.stringify({
                    type: 'entry',
                    value: nick_name
                }))
                // ws.send(nick_name)
            }

            ws.onmessage = e => {
                const data = JSON.parse(e.data)

                switch (data.type) {
                    case 'entry':
                        news_wrap.append(createEntryNode(data))
                        break;
                    case 'message':
                        news_wrap.append(createMsgNode(data));
                        message_send.value = ''
                        break;
                    default:
                        break;
                }
            }
        }

        function createEntryNode(data) {
            let node = document.createElement('div')
            node.classList.add('user_status')
            let children = document.createElement('span')
            if(data.value == nick_name) {
                children.innerText = '欢迎进入聊天室'
            }else {
                children.innerText = data.value + '进入聊天室'
            }
            node.append(children)
            console.log(node);
            return node
        }

        function sendMsg(params) {
            const msg = message_send.value
            if(!msg) return

            ws.send(JSON.stringify({
                type: 'message',
                nick_name,
                value:{
                    msg
                }
            }))
        }

        function createMsgNode(data) {
            const node = document.createElement('div')
            if(data.nick_name == nick_name) {
                node.classList.add('right')
            }else {
                node.classList.add('left')
            }
            const children = `<div class="user_info">
                        ${nick_name} ${data.value.time}
                    </div>
                    <div class="message">
                        ${data.value.msg}
                    </div>`
            node.innerHTML = children
            return node
        }
    </script>
</body>
</html>